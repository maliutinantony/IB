Поиск проблем в сети Infiniband
* `ibtracert` `ibnetdiscover` `IBstat`



1. **Получить базовую информацию о сети:**
   
   Это можно сделать с помощью `ibnetdiscover`:
   
   ```sh
   sudo ibnetdiscover > /tmp/ibnetdiscover.out
   cat /tmp/ibnetdiscover.out
   ```

2. **Получить LID (Local Identifier), GUID (Globally Unique Identifier) или IPoIB адрес каждого из серверов:**

   LID можно узнать с помощью команды `ibstat`:

   ```sh
   ibstat
   ```

   Или напрямую узнать IPoIB интерфейс:

   ```sh
   ifconfig
   ```

   Конкретно для получения GUID:

   ```sh
   cat /sys/class/infiniband/mlx5_0/ports/1/gid_attrs/ndevs/0/npf/gid_attrs/GID_tbl0
   ```

3. **Проверить количество хопов с помощью `ibtracert`:**

   Используйте LID серверов для определения маршрута и количества хопов между ними.

   ```sh
   sudo ibtracert <LID_сервера_1> <LID_сервера_2>
   ```

   Например:

   ```sh
   sudo ibtracert 0x1 0x2
   ```

   Результаты команды покажут путь и количество хопов между двумя серверами.

4. **Проверить связь с определенного хоста (с использованием IPoIB):**

   Если у вас настроен IPoIB, вы можете использовать `ping`:

   ```sh
   ping <IP_сервера_2>
   ```

5. **Поиск в таблицах маршрутизации:**

   Обычно маршруты хранятся в Subnet Manager (SM). Убедитесь, что управляющий демон SM активен, например OpenSM:

   ```sh
   sudo systemctl status opensm
   ```

Использование этих команд должно позволить вам определить, как сервера соединены и через сколько хопов они общаются в сети Infiniband.

Продолжим с более подробным рассмотрением других утилит, которые могут быть полезны для анализа и диагностики сети Infiniband, а также с примерами их использования.

### Анализ и диагностика сети Infiniband

6. **Использование `ibroute` для просмотра таблицы маршрутизации:**

   Утилита `ibroute` покажет текущую таблицу маршрутизации Subnet Manager для всех LID в сети.

   ```sh
   ibroute
   ```

   Для получения информации по конкретному LID:

   ```sh
   ibroute <LID>
   ```

   Например:

   ```sh
   ibroute 0x1
   ```

7. **Использование `iblinkinfo` для получения топологии сети:**

   Утилита `iblinkinfo` предоставляет исчерпывающую информацию о топологии сети, включая ссылки и порты.

   ```sh
   iblinkinfo -R
   ```

   Ключ `-R` показывает полный путь от маршрутизатора до конечного узла.

8. **Проверка состояния портов с помощью `ibportstate`:**

   Утилита `ibportstate` позволяет проверить и изменить состояние портов Infiniband.

   Для проверки состояния порта:

   ```sh
   ibportstate <lid_or_guid> <port_num> query
   ```

   Например:

   ```sh
   ibportstate 0x1 1 query
   ```

9. **Использование `sminfo` для получения информации о Subnet Manager:**

   Утилита `sminfo` выводит информацию о текущем Subnet Manager.

   ```sh
   sminfo
   ```

10. **Использование `perfquery` для мониторинга производительности:**

    Утилита `perfquery` позволяет получать статистику производительности портов, такую как количество информационных и контрольных ошибок.

    ```sh
    perfquery -x <LID> <Port_Number>
    ```

    Например:

    ```sh
    perfquery -x 0x1 1
    ```

11. **Использование `ibcheckerrors` для анализа ошибок в сети:**

    Утилита `ibcheckerrors` поможет найти ошибки и проблемные места в сети.

    ```sh
    ibcheckerrors -v
    ```

### Пример комплексного анализа сети Infiniband

1. **Получите базовую информацию и топологию сети:**

   ```sh
   sudo ibnetdiscover > /tmp/ibnetdiscover.out
   cat /tmp/ibnetdiscover.out
   ```

2. **Установите LID ваших серверов:**

   ```sh
   ibstat
   ```

3. **Определите маршрут между серверами и число хопов:**

   ```sh
   sudo ibtracert <LID_сервера_1> <LID_сервера_2>
   ```

4. **Проверьте таблицу маршрутизации:**

   ```sh
   ibroute <LID>
   ```

5. **Просмотрите полную топологию сети:**

   ```sh
   iblinkinfo -R
   ```

6. **Проверьте состояние портов:**

   ```sh
   ibportstate <lid_or_guid> <port_num> query
   ```

7. **Дополнительно проверьте наличие ошибок:**

   ```sh
   ibcheckerrors -v
   ```

Эти команды и шаги позволят вам получить полное представление о состоянии сети Infiniband, понять, как соединены сервера, и определить число хопов между ними.
